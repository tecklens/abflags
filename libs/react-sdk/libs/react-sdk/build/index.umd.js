(function(a,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("react/jsx-runtime"),require("react")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","react"],c):(a=typeof globalThis<"u"?globalThis:a||self,c(a["ab-react"]={},a.jsxRuntime,a.React))})(this,function(a,c,d){"use strict";var S,R,_,A,x,k,N,U,D,P,C,O,H,F,M,j,K,L,W,V,B,G,$,q,J,Y,z,Q,X,Z,ee;function te(){return c.jsx("div",{children:c.jsx("h1",{children:"Welcome to ReactSdk!"})})}var g={exports:{}};function p(){}p.prototype={on:function(s,e,t){var i=this.e||(this.e={});return(i[s]||(i[s]=[])).push({fn:e,ctx:t}),this},once:function(s,e,t){var i=this;function r(){i.off(s,r),e.apply(t,arguments)}return r._=e,this.on(s,r,t)},emit:function(s){var e=[].slice.call(arguments,1),t=((this.e||(this.e={}))[s]||[]).slice(),i=0,r=t.length;for(i;i<r;i++)t[i].fn.apply(t[i].ctx,e);return this},off:function(s,e){var t=this.e||(this.e={}),i=t[s],r=[];if(i&&e)for(var n=0,h=i.length;n<h;n++)i[n].fn!==e&&i[n].fn._!==e&&r.push(i[n]);return r.length?t[s]=r:delete t[s],this}},g.exports=p;var se=g.exports.TinyEmitter=p;const v="api_key",y="session_id",b=30;let f;const ie=new Uint8Array(16);function re(){if(!f&&(f=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!f))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return f(ie)}const o=[];for(let s=0;s<256;++s)o.push((s+256).toString(16).slice(1));function ne(s,e=0){return o[s[e+0]]+o[s[e+1]]+o[s[e+2]]+o[s[e+3]]+"-"+o[s[e+4]]+o[s[e+5]]+"-"+o[s[e+6]]+o[s[e+7]]+"-"+o[s[e+8]]+o[s[e+9]]+"-"+o[s[e+10]]+o[s[e+11]]+o[s[e+12]]+o[s[e+13]]+o[s[e+14]]+o[s[e+15]]}const w={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function oe(s,e,t){if(w.randomUUID&&!e&&!s)return w.randomUUID();s=s||{};const i=s.random||(s.rng||re)();return i[6]=i[6]&15|64,i[8]=i[8]&63|128,ne(i)}class ae{generateEventId(){return oe()}createImpressionEvent(e,t,i,r,n,h){const m=this.createBaseEvent(e,t,i,r,n);return h?{...m,variant:h}:m}createBaseEvent(e,t,i,r,n){return{eventType:r,eventId:this.generateEventId(),context:e,enabled:t,featureName:i,impressionData:n}}}class he{constructor(e="ab:cache"){this.prefix=e}async save(e,t){const i=JSON.stringify(t),r=`${this.prefix}:${e}`;try{window.localStorage.setItem(r,i)}catch(n){console.error(n)}}get(e){try{const t=`${this.prefix}:${e}`,i=window.localStorage.getItem(t);return i?JSON.parse(i):void 0}catch(t){console.error(t)}}}class ce{constructor(){this.store=new Map}async save(e,t){this.store.set(e,t)}async get(e){return this.store.get(e)}}const le=((S=globalThis.window)==null?void 0:S.document)!==void 0,de=((_=(R=globalThis.process)==null?void 0:R.versions)==null?void 0:_.node)!==void 0;(x=(A=globalThis.process)==null?void 0:A.versions)==null||x.bun,(N=(k=globalThis.Deno)==null?void 0:k.version)==null||N.deno,(D=(U=globalThis.process)==null?void 0:U.versions)==null||D.electron,(C=(P=globalThis.navigator)==null?void 0:P.userAgent)==null||C.includes("jsdom"),typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope,typeof DedicatedWorkerGlobalScope<"u"&&globalThis instanceof DedicatedWorkerGlobalScope,typeof SharedWorkerGlobalScope<"u"&&globalThis instanceof SharedWorkerGlobalScope,typeof ServiceWorkerGlobalScope<"u"&&globalThis instanceof ServiceWorkerGlobalScope;const u=(H=(O=globalThis.navigator)==null?void 0:O.userAgentData)==null?void 0:H.platform,ue=u==="macOS"||((F=globalThis.navigator)==null?void 0:F.platform)==="MacIntel"||((j=(M=globalThis.navigator)==null?void 0:M.userAgent)==null?void 0:j.includes(" Mac "))===!0||((K=globalThis.process)==null?void 0:K.platform)==="darwin",fe=u==="Windows"||((L=globalThis.navigator)==null?void 0:L.platform)==="Win32"||((W=globalThis.process)==null?void 0:W.platform)==="win32",me=u==="Linux"||((B=(V=globalThis.navigator)==null?void 0:V.platform)==null?void 0:B.startsWith("Linux"))===!0||(($=(G=globalThis.navigator)==null?void 0:G.userAgent)==null?void 0:$.includes(" Linux "))===!0||((q=globalThis.process)==null?void 0:q.platform)==="linux",pe=u==="iOS"||((J=globalThis.navigator)==null?void 0:J.platform)==="MacIntel"&&((Y=globalThis.navigator)==null?void 0:Y.maxTouchPoints)>1||/iPad|iPhone|iPod/.test((z=globalThis.navigator)==null?void 0:z.platform);u==="Android"||((Q=globalThis.navigator)==null?void 0:Q.platform)==="Android"||((Z=(X=globalThis.navigator)==null?void 0:X.userAgent)==null?void 0:Z.includes(" Android "))===!0||((ee=globalThis.process)==null||ee.platform);const l={INIT:"initialized",ERROR:"error",READY:"ready",UPDATE:"update",IMPRESSION:"impression",SENT:"sent",RECOVERED:"recovered"},I=([,s])=>s!=null,ge=s=>JSON.stringify(s),ve=async s=>{var r,n;const e=typeof globalThis<"u"&&((r=globalThis.crypto)!=null&&r.subtle)?(n=globalThis.crypto)==null?void 0:n.subtle:void 0;if(typeof TextEncoder>"u"||!(e!=null&&e.digest)||typeof Uint8Array>"u")throw new Error("Hashing function not available");const t=new TextEncoder().encode(s),i=await e.digest("SHA-256",t);return Array.from(new Uint8Array(i)).map(h=>h.toString(16).padStart(2,"0")).join("")},T=async s=>{const e=ge(s);try{return await ve(e)}catch{return e}},ye=()=>{try{if(typeof window<"u"&&"fetch"in window)return fetch.bind(window);if("fetch"in globalThis)return fetch.bind(globalThis)}catch(s){console.error('Unleash failed to resolve "fetch"',s)}},be=()=>{try{if(typeof window<"u"&&"AbortController"in window)return new window.AbortController;if("fetch"in globalThis)return new globalThis.AbortController}catch(s){console.error('Unleash failed to resolve "AbortController" factory',s)}},we=()=>({os:ue?"mac-os":fe?"window":me?"linux":pe?"ios":"android",environment:le?"browser":de?"backend":"web-worker"}),Ie=()=>{};class Te{constructor({onError:e,onSent:t,appName:i,metricsInterval:r,disableMetrics:n=!1,url:h,clientKey:m,fetch:_e,customHeaders:Ae={},metricsIntervalInitial:xe}){this.onError=e,this.onSent=t||Ie,this.disabled=n,this.metricsInterval=r??1e3,this.metricsIntervalInitial=xe??1e3,this.appName=i,this.url=h instanceof URL?h:new URL(h),this.clientKey=m,this.bucket=this.createEmptyBucket(),this.fetch=_e,this.customHeaders=Ae,this.environment=we()}start(){if(this.disabled)return!1;typeof this.metricsInterval=="number"&&this.metricsInterval>0&&(this.metricsIntervalInitial&&this.metricsIntervalInitial>0?setTimeout(async()=>{this.startTimer(),await this.sendMetrics()},this.metricsIntervalInitial):this.startTimer())}stop(){this.timer&&(clearTimeout(this.timer),delete this.timer)}createEmptyBucket(){return{start:new Date,stop:null,features:{}}}getHeaders(){const e={[v]:this.clientKey,Accept:"application/json","Content-Type":"application/json"};return Object.entries(this.customHeaders).filter(I).forEach(([t,i])=>e[t]=i),e}async sendMetrics(){const e=`${this.url}ab/v1/metric`,t=this.getPayload();if(!this.bucketIsEmpty(t))try{await this.fetch(e,{cache:"no-cache",method:"POST",headers:this.getHeaders(),body:JSON.stringify(t)}),this.onSent(t)}catch(i){console.error("AbFlags: unable to send feature metrics",i),this.onError(i)}}count(e,t){return this.disabled||!this.bucket?!1:(this.assertBucket(e),this.bucket.features[e][t?"yes":"no"]++,!0)}assertBucket(e){if(this.disabled||!this.bucket)return!1;this.bucket.features[e]||(this.bucket.features[e]={yes:0,no:0})}startTimer(){this.timer=setInterval(async()=>{await this.sendMetrics()},this.metricsInterval)}bucketIsEmpty(e){return Object.keys(e.bucket.features).length===0}getPayload(){const e={...this.bucket,stop:new Date};return this.bucket=this.createEmptyBucket(),{bucket:e,createdAt:new Date,appName:this.appName,instanceId:"browser",os:this.environment.os,environment:this.environment.environment}}}class Ee extends se{constructor(e){if(super(),this.readyEventEmitted=!1,this.storeKey="feature",this.lastUpdateKey="last-time",this.etag="",this.fetchedFromServer=!1,this.started=!1,!e.clientKey)throw new Error("clientKey is required");if(!e.appName)throw new Error("appName is required.");this.eventsHandler=new ae,this.url=e.url??"https://ab.wolfx.app",this.storage=e.storageProvider||(typeof window<"u"?new he:new ce),this.fetch=ye(),this.fetch||console.error('You must either provide your own "fetch" implementation or run in an environment where "fetch" is available.'),this._config=e,this.ready=new Promise(t=>{this.init().then(t).catch(i=>{console.debug(i),this.state="error",this.emit(l.ERROR,i),this.lastError=i,t()})}),this.features=[],this.lastRefreshTimestamp=0,this.state="initializing",this.metrics=new Te({onError:this.emit.bind(this,l.ERROR),onSent:this.emit.bind(this,l.SENT),appName:this._config.appName,metricsInterval:this._config.metricsInterval,disableMetrics:this._config.disableMetrics??!1,url:this.url,clientKey:this._config.clientKey,fetch:this.fetch,customHeaders:this._config.customHeaders,metricsIntervalInitial:this._config.metricsIntervalInitial??1e3})}async init(){this._config.sessionId=await this.resolveSessionId(),this.features=await this.storage.get(this.storeKey)||[],this.lastRefreshTimestamp=await this.getLastRefreshTimestamp(),this.state="healthy",this.emit(l.INIT)}async start(){if(this.started=!0,this.timerRef){console.error("SDK has already started, if you want to restart the SDK you should call client.stop() before starting again.");return}await this.ready,this.metrics.start();const e=this._config.refreshInterval&&this._config.refreshInterval>500?this._config.refreshInterval:b;await this.initialFetchFeatures(),e>0&&(this.timerRef=setInterval(()=>this.fetchFeatures(),e))}async getLastRefreshTimestamp(){const e=await this.storage.get(this.lastUpdateKey),t=await T({appName:this._config.appName,sessionId:this._config.sessionId,currentTime:this._config.currentTime,userId:this._config.userId,environment:this._config.environment,properties:this._config.properties});return(e==null?void 0:e.key)===t?e.timestamp:0}setReady(){this.readyEventEmitted=!0,this.emit(l.READY)}async storeLastRefreshTimestamp(){this.lastRefreshTimestamp=Date.now();const t={key:await T({appName:this._config.appName,sessionId:this._config.sessionId,currentTime:this._config.currentTime,userId:this._config.userId,environment:this._config.environment,properties:this._config.properties}),timestamp:this.lastRefreshTimestamp};await this.storage.save(this.lastUpdateKey,t)}async resolveSessionId(){let e=await this.storage.get(y);return e||(e=Math.floor(Math.random()*1e9),await this.storage.save(y,e.toString(10))),e.toString(10)}isUpToDate(){const e=Date.now(),t=this._config.refreshInterval&&this._config.refreshInterval>500?this._config.refreshInterval:b;return this.lastRefreshTimestamp>0&&this.lastRefreshTimestamp<=e&&e-this.lastRefreshTimestamp<=t}initialFetchFeatures(){if(this.isUpToDate()){this.fetchedFromServer||(this.fetchedFromServer=!0,this.setReady());return}return this.fetchFeatures()}async fetchFeatures(){if(this.fetch){this.abortController&&this.abortController.abort(),this.abortController=be();const e=this.abortController?this.abortController.signal:void 0;try{const t=new URL("/ab/v1/feature/frontend",this.url),i="GET";t.searchParams.set("appName",this._config.appName),t.searchParams.set("environment",this._config.environment??""),t.searchParams.set("userId",this._config.userId??""),t.searchParams.set("sessionId",this._config.sessionId??""),t.searchParams.set("currentTime",this._config.currentTime??new Date().toString());for(let n of Object.entries(this._config.properties??{}))t.searchParams.set(n[0],n[1]);const r=await this.fetch(t.toString(),{method:i,cache:"no-cache",headers:this.getHeaders(),signal:e});if(this.state==="error"&&r.status<400&&(this.state="healthy",this.emit(l.RECOVERED)),r.ok){this.etag=r.headers.get("ETag")||"";const n=await r.json();await this.storeFeatures(n),this.state!=="healthy"&&(this.state="healthy"),this.fetchedFromServer||(this.fetchedFromServer=!0,this.setReady()),this.storeLastRefreshTimestamp()}else r.status===304?this.storeLastRefreshTimestamp():(console.error("AbFlags: Fetching feature toggles did not have an ok response"),this.state="error",this.emit(l.ERROR,{type:"HttpError",code:r.status}),this.lastError={type:"HttpError",code:r.status})}catch(t){typeof t=="object"&&t!==null&&"name"in t&&t.name==="AbortError"||(console.error("AbFlags: unable to fetch feature toggles",t),this.state="error",this.emit(l.ERROR,t),this.lastError=t)}finally{this.abortController=null}}}async storeFeatures(e){this.features=e,this.emit(l.UPDATE),await this.storage.save(this.storeKey,e)}getHeaders(){const e={[v]:this._config.clientKey,Accept:"application/json"};return e["Content-Type"]="application/json",this.etag&&(e["If-None-Match"]=this.etag),Object.entries(this._config.customHeaders??{}).filter(I).forEach(([t,i])=>e[t]=i),e}isEnabled(e){var i;const t=!!((i=this.features)!=null&&i.find(r=>r.name===e));return this.metrics.count(e,t),t}}const E=d.createContext(void 0),Se=({children:s,config:e})=>{const[t,i]=d.useState();d.useEffect(()=>{i(new Ee({url:e.url,clientKey:e.clientKey,appName:e.appName,userId:e.userId,disableMetrics:e.disableMetrics,metricsInterval:e.metricsInterval,refreshInterval:e.refreshInterval}))},[e]);const r=d.useMemo(()=>({...e,client:t}),[e,t]);return c.jsx(c.Fragment,{children:c.jsx(E.Provider,{value:r,children:s})})},Re=()=>d.useContext(E);a.AbClient=te,a.AbProvider=Se,a.useAbflags=Re,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=index.umd.js.map
